# DIO Platform - Production Ready

services:
  # Frontend Dashboard
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_WS_URL=ws://localhost:4222
      - DATABASE_URL=postgresql://dio_user:dio_password@database:5432/dio_platform
      - NERVE_CENTER_URL=http://nerve-center:8000
    depends_on:
      - database
      - nerve-center
      - mesh-network
    networks:
      - dio-network
    volumes:
      - ./db:/app/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - production

  # Nerve Center - AI Core
  nerve-center:
    build:
      context: ./components/nerve-center
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://dio_user:dio_password@database:5432/dio_platform
    networks:
      - dio-network
    depends_on:
      - database
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - production

  # Mesh Network - Communication Backbone
  mesh-network:
    build:
      context: ./components/mesh-network
      dockerfile: Dockerfile
    ports:
      - "4222:4222"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - dio-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import websockets; print('Mesh Network healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agent Service - Endpoint Monitoring
  agent:
    build:
      context: ./components/agent
      dockerfile: Dockerfile
    environment:
      - NERVE_CENTER_URL=http://nerve-center:8000
      - MONITORING_INTERVAL=5
      - ANOMALY_THRESHOLD=80.0
      - PYTHONUNBUFFERED=1
    networks:
      - dio-network
    depends_on:
      - nerve-center
    restart: unless-stopped
    scale: ${AGENT_COUNT:-3}
    profiles:
      - production

  # Attack Simulator - Security Testing Tool
  attack-simulator:
    build:
      context: ./components/attack-simulator
      dockerfile: Dockerfile
    environment:
      - NERVE_CENTER_URL=http://nerve-center:8000
      - PYTHONUNBUFFERED=1
    networks:
      - dio-network
    depends_on:
      - nerve-center
    profiles:
      - testing
    restart: "no"

  # Mock Data Service - Development/Testing
  mock-data:
    build:
      context: ./components/mock-data
      dockerfile: Dockerfile
    environment:
      - NERVE_CENTER_URL=http://nerve-center:8000
      - MESH_NETWORK_URL=ws://mesh-network:4222
      - NUM_AGENTS=${MOCK_AGENT_COUNT:-12}
      - UPDATE_INTERVAL=10
      - THREAT_PROBABILITY=0.1
      - PYTHONUNBUFFERED=1
    networks:
      - dio-network
    depends_on:
      - nerve-center
      - mesh-network
    profiles:
      - development

  # Database (PostgreSQL for production)
  database:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=dio_platform
      - POSTGRES_USER=dio_user
      - POSTGRES_PASSWORD=dio_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dio-network
    restart: unless-stopped
    profiles:
      - production
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - dio-network
    restart: unless-stopped
    profiles:
      - production

  # NATS JetStream for messaging
  nats:
    image: nats:2.10-alpine
    ports:
      - "8222:8222"
    command: ["--store_dir", "/data", "--jetstream"]
    volumes:
      - nats_data:/data
    networks:
      - dio-network
    restart: unless-stopped
    profiles:
      - production

# Network Configuration
networks:
  dio-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes Configuration
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  nats_data:
    driver: local